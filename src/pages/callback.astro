---
import { getAbsoluteUrl, refreshUserInfo, states } from 'utils/auth'
import { ConvexHttpClient } from 'convex/browser'
import { ulid } from 'ulidx'

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL
const getConvexClient = () => {
  if (!convexUrl) throw new Error('PUBLIC_CONVEX_URL not set')
  return new ConvexHttpClient(convexUrl)
}

const code = Astro.url.searchParams.get('code')
const state = Astro.url.searchParams.get('state')

if (Astro.url.searchParams.has('error')) return Astro.redirect(getAbsoluteUrl(Astro.url, '/'))

if (!code || !state || !states.has(state)) return Astro.redirect(getAbsoluteUrl(Astro.url, '/login'))

// eslint-disable-next-line @typescript-eslint/no-non-null-assertion
const { codeVerifier } = states.get(state)!

const [userInfo, , exists] = await refreshUserInfo(
  {
    grant_type: 'authorization_code',
    client_id: import.meta.env.OAUTH_CLIENT_ID,
    redirect_uri: getAbsoluteUrl(Astro.url, '/callback'),
    code,
    code_verifier: codeVerifier
  },
  Astro.cookies
)
if (!userInfo) return Astro.redirect(getAbsoluteUrl(Astro.url, '/'))

const convex = getConvexClient()
const { api } = await import('../../convex/_generated/api')

if (!exists) {
  // Generate a UUID for the new user (no longer using Supabase Auth)
  const uuid = ulid()
  
  // Get next visible ID
  const nextUserId = await convex.query(api.users.getNextVisibleId, {})
  
  await convex.mutation(api.users.create, {
    visibleId: userInfo.id || nextUserId,
    uuid,
    username: userInfo.username,
    profileUrl: userInfo.profileUrl,
    role: 'MEMBER',
    refreshToken: userInfo.refreshToken
  })
  console.log('User created!')
} else {
  // Update existing user
  const user = await convex.query(api.users.getByVisibleId, { visibleId: userInfo.id })
  if (user) {
    await convex.mutation(api.users.update, {
      id: user._id,
      username: userInfo.username,
      profileUrl: userInfo.profileUrl,
      refreshToken: userInfo.refreshToken
    })
    console.log('User updated!')
  }
}

return Astro.redirect('/')
---
