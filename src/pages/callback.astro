---
import { prisma } from 'db/prisma/prisma'
import { refreshUserInfo, states } from 'utils/auth'

const code = Astro.url.searchParams.get('code')
const state = Astro.url.searchParams.get('state')

if (!code || !state || !states.has(state)) return new Response(null, { status: 403 })

// eslint-disable-next-line @typescript-eslint/no-non-null-assertion
const { codeVerifier } = states.get(state)!

const data = await refreshUserInfo(
  {
    grant_type: 'authorization_code',
    client_id: import.meta.env.OAUTH_CLIENT_ID,
    redirect_uri: 'http://localhost:3000/callback',
    code,
    code_verifier: codeVerifier
  },
  Astro.cookies
)
if (!data) return new Response(null, { status: 403 })

await prisma.user.create({ data })

return Astro.redirect('/')
---
